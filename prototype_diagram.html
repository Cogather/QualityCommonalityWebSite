<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI数据飞轮 - 分类校验平台</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- ECharts WordCloud -->
    <script src="https://unpkg.com/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>

    <style>
        :root {
            --el-color-primary: #409EFF;
            --el-bg-color: #f5f7fa;
            --el-text-color-primary: #303133;
            --el-text-color-regular: #606266;
        }
        body { margin: 0; background-color: var(--el-bg-color); font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; color: var(--el-text-color-primary); }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .header { background: #fff; height: 60px; border-bottom: 1px solid #dcdfe6; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); z-index: 10; }
        .logo { font-size: 20px; font-weight: bold; color: #303133; display: flex; align-items: center; gap: 10px; }
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 240px; background: #fff; border-right: 1px solid #dcdfe6; display: flex; flex-direction: column; transition: width 0.3s; }
        .content { flex: 1; padding: 24px; overflow-y: auto; background-color: #f5f7fa; }

        /* Dashboard Grid Layout */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .chart-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .full-width-chart { margin-bottom: 20px; }

        /* Modern Card Style */
        .modern-card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #ebeef5; transition: transform 0.2s, box-shadow 0.2s; height: 100%; box-sizing: border-box; }
        .modern-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 16px; font-weight: 600; color: #303133; margin: 0; }
        
        /* Stat Items */
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 14px; color: #909399; margin-bottom: 8px; }
        .stat-num { font-size: 32px; font-weight: 700; color: #303133; line-height: 1.2; }
        .stat-trend { font-size: 13px; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: #67C23A; }
        .trend-down { color: #F56C6C; }

        /* Task Cards */
        .task-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .task-card { border-left: 4px solid var(--el-color-primary); }
        .task-card.completed { border-left-color: #67C23A; }
        
        /* Issue Item */
        .issue-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 16px; overflow: hidden; }
        .issue-header-bar { padding: 12px 20px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .issue-content { padding: 20px; }
        .ai-badge { background: linear-gradient(135deg, #ecf5ff 0%, #d9ecff 100%); color: #409EFF; padding: 6px 12px; border-radius: 6px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }

        /* Login Page */
        .login-container { height: 100vh; display: flex; align-items: center; justify-content: center; background: #2d3a4b; background-image: radial-gradient(#409EFF 1px, transparent 1px); background-size: 30px 30px; }
        .login-card { width: 400px; background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .login-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #303133; }
        .login-subtitle { font-size: 14px; color: #909399; margin-bottom: 30px; }
        .login-form { text-align: left; }
        .role-btn { width: 100%; margin-left: 0 !important; margin-bottom: 15px; height: 40px; font-size: 14px; }

        /* Guest Page */
        .guest-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f0f2f5; text-align: center; }
        .guest-icon { font-size: 80px; color: #E6A23C; margin-bottom: 20px; }
        .guest-title { font-size: 24px; font-weight: bold; color: #303133; margin-bottom: 10px; }
        .guest-desc { font-size: 14px; color: #606266; margin-bottom: 30px; max-width: 400px; line-height: 1.6; }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Screen -->
        <div v-if="!isLoggedIn" class="login-container">
            <div class="login-card">
                <div style="margin-bottom: 20px;">
                    <div style="background: #409EFF; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <el-icon color="#fff" :size="30"><Data-Line /></el-icon>
                    </div>
                </div>
                <div class="login-title">AI数据飞轮系统</div>
                <div class="login-subtitle">请登录您的账号</div>
                
                <el-form class="login-form" @submit.prevent="handleLogin">
                    <el-form-item>
                        <el-input v-model="loginForm.username" placeholder="用户名 (admin / user / guest)" prefix-icon="User"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-input v-model="loginForm.password" type="password" placeholder="密码 (任意)" prefix-icon="Lock" show-password></el-input>
                    </el-form-item>
                    <el-button type="primary" style="width: 100%; height: 40px; font-size: 16px;" @click="handleLogin" :loading="loginLoading">登 录</el-button>
                </el-form>

                <div style="margin-top: 20px; font-size: 12px; color: #C0C4CC; text-align: left; line-height: 1.6;">
                    <p style="margin: 0;"><strong>测试账号说明：</strong></p>
                    <p style="margin: 0;">• <strong>admin</strong>: 进入管理员后台</p>
                    <p style="margin: 0;">• <strong>user</strong>: 进入普通用户工作台</p>
                    <p style="margin: 0;">• <strong>guest</strong> (或其他): 进入游客审核页</p>
                </div>
            </div>
        </div>
        
        <!-- Guest Page -->
        <div v-else-if="currentRole === 'guest'" class="guest-container">
             <el-icon class="guest-icon"><Lock /></el-icon>
             <div class="guest-title">权限审核中</div>
             <div class="guest-desc">您的账号已注册成功，但尚未分配业务权限。<br>请联系系统管理员为您开通权限后，重新登录。</div>
             <el-button type="primary" @click="logout">返回登录页</el-button>
        </div>

        <div v-else class="app-container">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <div style="background: #409EFF; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <el-icon color="#fff" :size="20"><Data-Line /></el-icon>
                    </div>
                    <span>AI数据飞轮系统</span>
                    <el-tag :type="currentRole === 'admin' ? 'danger' : 'success'" effect="plain" round size="small" style="margin-left: 8px; font-weight: normal;">
                        {{ currentRole === 'admin' ? '管理员 (Administrator)' : '普通用户 (User)' }}
                    </el-tag>
                </div>
                <div class="actions" style="display: flex; align-items: center; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <el-avatar :size="32" :src="currentRole === 'admin' ? 'https://cube.elemecdn.com/0/88/03b0d39583f48206768a7534e55bcpng.png' : 'https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png'"></el-avatar>
                        <span style="font-size: 14px; font-weight: 500;">{{ currentRole === 'admin' ? 'Admin' : 'Operator_01' }}</span>
                        <el-icon @click="logout" style="margin-left: 10px; color: #909399;" title="退出登录"><Switch-Button /></el-icon>
                    </div>
                </div>
            </div>

            <div class="main">
                <!-- Sidebar -->
                <div class="sidebar">
                    <el-menu :default-active="activeMenu" @select="handleMenuSelect" text-color="#606266" active-text-color="#409EFF" style="border: none; padding-top: 10px;">
                        
                        <!-- Common Menu -->
                        <el-menu-item index="dashboard">
                            <el-icon><Odometer /></el-icon>
                            <span>{{ currentRole === 'admin' ? '全局概览' : '个人中心' }}</span>
                        </el-menu-item>

                        <!-- Admin Specific -->
                        <template v-if="currentRole === 'admin'">
                            <el-menu-item-group title="数据管理">
                                <el-menu-item index="batch-manage">
                                    <el-icon><Files /></el-icon>
                                    <span>批次分发</span>
                                </el-menu-item>
                            </el-menu-item-group>
                        </template>

                        <!-- User Specific -->
                        <template v-if="currentRole === 'user'">
                             <el-menu-item-group title="任务中心">
                                <el-menu-item index="my-tasks">
                                    <el-icon><List /></el-icon>
                                    <span>我的任务</span>
                                </el-menu-item>
                            </el-menu-item-group>
                        </template>
                    </el-menu>
                </div>

                <!-- Content Area -->
                <div class="content">
                    <transition name="fade" mode="out-in">
                        
                        <!-- ================= ADMIN DASHBOARD ================= -->
                        <div v-if="currentRole === 'admin' && activeMenu === 'dashboard'" key="admin-dash">
                            <div style="margin-bottom: 24px;">
                                <h2 style="margin: 0; font-weight: 600;">欢迎回来，管理员</h2>
                                <p style="color: #909399; margin: 8px 0 0 0; font-size: 14px;">以下是今日的AI模型表现及人工校验进度概览。</p>
                            </div>

                            <!-- Top Stats -->
                            <div class="dashboard-grid">
                                <div class="modern-card">
                                    <div class="stat-item">
                                        <span class="stat-label">AI预测总数 (条)</span>
                                        <span class="stat-num">{{ formatNumber(stats.totalPredictions) }}</span>
                                        <span class="stat-trend trend-up"><el-icon><Top /></el-icon> 较昨日 +12%</span>
                                    </div>
                                </div>
                                <div class="modern-card">
                                    <div class="stat-item">
                                        <span class="stat-label">模型准确率 (Accuracy)</span>
                                        <span class="stat-num">{{ stats.accuracy }}%</span>
                                        <span class="stat-trend trend-up"><el-icon><Top /></el-icon> 较上周 +1.2%</span>
                                    </div>
                                </div>
                                <div class="modern-card">
                                    <div class="stat-item">
                                        <span class="stat-label">待分发任务 (批次)</span>
                                        <span class="stat-num" style="color: #E6A23C">{{ stats.pendingBatches }}</span>
                                        <span class="stat-trend trend-down" style="color: #909399;">正常积压</span>
                                    </div>
                                </div>
                                <div class="modern-card">
                                    <div class="stat-item">
                                        <span class="stat-label">人工校验完成率</span>
                                        <span class="stat-num">{{ stats.correctionProgress }}%</span>
                                        <el-progress :percentage="stats.correctionProgress" :show-text="false" stroke-width="6" style="margin-top: 10px;"></el-progress>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Charts -->
                            <!-- AI Accuracy Trend Chart Removed -->

                            <div class="chart-row">
                                <div class="modern-card">
                                    <div class="card-header">
                                        <span class="card-title">Top 5 预测错误类别</span>
                                    </div>
                                    <div id="chart-top-error" style="height: 300px; width: 100%;"></div>
                                </div>
                                <div class="modern-card">
                                    <div class="card-header">
                                        <span class="card-title">问题分类词云分布</span>
                                    </div>
                                    <div id="chart-wordcloud" style="height: 300px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- ================= USER DASHBOARD ================= -->
                        <div v-else-if="currentRole === 'user' && activeMenu === 'dashboard'" key="user-dash">
                            <div style="margin-bottom: 24px;">
                                <h2 style="margin: 0; font-weight: 600;">工作台</h2>
                                <p style="color: #909399; margin: 8px 0 0 0; font-size: 14px;">你好 Operator_01，准备好开始今天的校验工作了吗？</p>
                            </div>

                            <div class="dashboard-grid" style="grid-template-columns: 1fr;">
                                <div class="modern-card">
                                    <div class="stat-item">
                                        <span class="stat-label">我的待办任务</span>
                                        <span class="stat-num" style="color: #409EFF">{{ myTasks.reduce((acc, t) => acc + (t.totalCount - t.processedCount), 0) }}</span>
                                        <span class="stat-trend">涉及 {{ myTasks.length }} 个批次</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modern-card">
                                <div class="card-header">
                                    <span class="card-title">快捷入口：最近的任务</span>
                                    <el-button type="primary" link @click="activeMenu='my-tasks'">查看全部 <el-icon><Arrow-Right /></el-icon></el-button>
                                </div>
                                <el-table :data="myTasks.slice(0, 3)" style="width: 100%">
                                    <el-table-column prop="fileName" label="批次文件"></el-table-column>
                                    <el-table-column label="进度" width="300">
                                        <template #default="scope">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <el-progress :percentage="Math.round((scope.row.processedCount/scope.row.totalCount)*100)" style="flex: 1"></el-progress>
                                                <span style="font-size: 12px; color: #909399;">{{scope.row.processedCount}}/{{scope.row.totalCount}}</span>
                                            </div>
                                        </template>
                                    </el-table-column>
                                    <el-table-column align="right">
                                        <template #default="scope">
                                            <el-button size="small" type="primary" plain round @click="enterTask(scope.row)">继续校验</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>

                        <!-- ================= BATCH MANAGEMENT (ADMIN) ================= -->
                        <div v-else-if="activeMenu === 'batch-manage'" key="batch">
                            <div class="card-header">
                                <h2 style="margin: 0;">批次分发管理</h2>
                                <el-upload action="#" :show-file-list="false" :auto-upload="false" :on-change="handleFileChange">
                                    <el-button type="primary" :icon="Upload">上传新批次 (JSON)</el-button>
                                </el-upload>
                            </div>
                            <div class="modern-card" style="margin-top: 20px;">
                                <el-table :data="batches" stripe style="width: 100%" size="large">
                                    <el-table-column prop="batchId" label="批次ID" width="180">
                                        <template #default="{row}">
                                            <span style="font-family: monospace;">{{ row.batchId }}</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="fileName" label="文件名" min-width="200"></el-table-column>
                                    <el-table-column prop="uploadTime" label="上传时间" width="180" sortable></el-table-column>
                                    <el-table-column prop="totalCount" label="数据量" width="120" align="center"></el-table-column>
                                    <el-table-column prop="status" label="状态" width="120">
                                        <template #default="scope">
                                            <el-tag :type="getStatusType(scope.row.status)" effect="light">{{ getStatusText(scope.row.status) }}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="assignee" label="当前处理人" width="150">
                                        <template #default="scope">
                                            <div v-if="scope.row.assignee" style="display: flex; align-items: center; gap: 5px;">
                                                <el-avatar :size="20" style="background: #409EFF">{{ scope.row.assignee.substring(0,1) }}</el-avatar>
                                                {{ scope.row.assignee }}
                                            </div>
                                            <span v-else style="color: #ccc;">-</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="操作" width="180" fixed="right">
                                        <template #default="scope">
                                            <el-button v-if="scope.row.status === 'pending'" type="primary" link @click="openDistributeDialog(scope.row)">分发</el-button>
                                            <el-button v-else-if="scope.row.status === 'assigned'" type="warning" link @click="openDistributeDialog(scope.row)">修改分发</el-button>
                                            <el-button v-else type="info" link disabled>已完成</el-button>
                                            <el-button type="danger" link>删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>

                        <!-- ================= MY TASKS (USER) ================= -->
                        <div v-else-if="activeMenu === 'my-tasks'" key="mytasks">
                            <!-- Task List -->
                            <div v-if="!currentTask">
                                <h2 style="margin-bottom: 24px;">我的校验任务</h2>
                                <div class="task-list">
                                    <div v-for="task in myTasks" :key="task.batchId" class="modern-card task-card" :class="{ completed: task.processedCount === task.totalCount }" style="cursor: pointer; padding: 20px;" @click="enterTask(task)">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                            <el-tag :type="task.processedCount === task.totalCount ? 'success' : 'primary'" effect="dark" size="small">
                                                {{ task.processedCount === task.totalCount ? '已完成' : '进行中' }}
                                            </el-tag>
                                            <span style="font-size: 12px; color: #999;">{{ task.uploadTime }}</span>
                                        </div>
                                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">{{ task.fileName }}</h3>
                                        <p style="color: #666; font-size: 13px; margin: 0 0 20px 0;">批次号: {{ task.batchId }}</p>
                                        
                                        <div style="margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                                            <span>进度</span>
                                            <span>{{ Math.round((task.processedCount/task.totalCount)*100) }}%</span>
                                        </div>
                                        <el-progress :percentage="Math.round((task.processedCount/task.totalCount)*100)" :show-text="false"></el-progress>
                                    </div>
                                </div>
                            </div>

                            <!-- Task Execution -->
                            <div v-else>
                                <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <el-button @click="currentTask = null" link><el-icon><Back /></el-icon>&nbsp;返回任务列表</el-button>
                                        <el-divider direction="vertical"></el-divider>
                                        <span style="font-weight: bold;">{{ currentTask.fileName }}</span>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <el-select v-model="filterCategory" placeholder="筛选聚类类别" clearable style="width: 150px">
                                            <el-option v-for="cat in categories" :key="cat" :label="cat" :value="cat"></el-option>
                                        </el-select>
                                        <el-button-group>
                                            <el-button :type="filterStatus==='all'?'primary':''" plain @click="filterStatus='all'">全部</el-button>
                                            <el-button :type="filterStatus==='pending'?'primary':''" plain @click="filterStatus='pending'">待办</el-button>
                                        </el-button-group>
                                    </div>
                                </div>
                                
                                <div class="modern-card">
                                    <el-table :data="tableData" style="width: 100%" :span-method="objectSpanMethod" border>
                                        <!-- Group Columns (Merged) -->
                                        <el-table-column prop="spdt" label="SPDT" width="100" align="center"></el-table-column>
                                        <el-table-column prop="ipmt" label="IPMT" width="100" align="center"></el-table-column>
                                        <el-table-column label="聚类类别" width="140" align="center">
                                            <template #default="{row}">
                                                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                                                    <el-tag type="info" effect="dark" size="small">{{ row.aiCategoryLarge }}</el-tag>
                                                    <el-icon style="transform: rotate(90deg); color: #909399; font-size: 12px;"><Arrow-Right /></el-icon>
                                                    <el-tag type="info" effect="plain" size="small">{{ row.aiCategorySub }}</el-tag>
                                                </div>
                                            </template>
                                        </el-table-column>
                                        <el-table-column prop="summary" label="聚类总结" width="200" show-overflow-tooltip>
                                            <template #default="{row}">
                                                <span style="color: #666; font-size: 12px;">{{ row.summary }}</span>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="问题数" width="80" align="center">
                                            <template #default="{row}">
                                                <el-badge :value="row.groupSize" type="info" />
                                            </template>
                                        </el-table-column>

                                        <!-- Requested Column Order -->
                                        <!-- 1. 用户矫正类别 (User Correction Category) -->
                                        <el-table-column label="用户矫正类别" width="220">
                                            <template #default="{row}">
                                                <div v-if="row.status === 'pending'" style="display: flex; gap: 8px;">
                                                    <el-button type="success" size="small" plain @click="verifyIssue(row)">准确</el-button>
                                                    <el-button type="primary" size="small" plain @click="openCorrection(row)">纠错</el-button>
                                                </div>
                                                <div v-else-if="row.status === 'verified'" style="display: flex; align-items: center; justify-content: space-between;">
                                                    <span style="color: #67C23A; font-size: 12px; display: flex; flex-direction: column; gap: 2px;">
                                                        <div style="display: flex; align-items: center; gap: 4px;"><el-icon><Check /></el-icon> AI准确</div>
                                                        <span style="color: #999; font-size: 11px;">{{ row.aiCategoryLarge }} > {{ row.aiCategorySub }}</span>
                                                    </span>
                                                    <el-button type="primary" link size="small" @click="openCorrection(row)">修改</el-button>
                                                </div>
                                                <div v-else-if="row.status === 'corrected'" style="display: flex; align-items: center; justify-content: space-between;">
                                                    <span style="font-size: 12px; color: #E6A23C; display: flex; flex-direction: column; gap: 2px;">
                                                        <div style="display: flex; align-items: center; gap: 4px;"><el-icon><Edit /></el-icon> 人工修正</div>
                                                        <span style="font-weight: 500;">{{ row.humanCategoryLarge }} > {{ row.humanCategorySub }}</span>
                                                    </span>
                                                    <el-button type="primary" link size="small" @click="openCorrection(row)">修改</el-button>
                                                </div>
                                            </template>
                                        </el-table-column>

                                        <!-- 2. 矫正说明 (Correction Note) -->
                                        <el-table-column label="矫正说明" width="150" show-overflow-tooltip>
                                            <template #default="{row}">
                                                {{ row.reason || '-' }}
                                            </template>
                                        </el-table-column>

                                        <!-- 3. PROD_EN_NAME -->
                                        <el-table-column prop="title" label="PROD_EN_NAME" min-width="180" show-overflow-tooltip></el-table-column>
                                        
                                        <!-- 4. RESOLUTION_DETAIL -->
                                        <el-table-column prop="resolution" label="RESOLUTION_DETAIL" min-width="150" show-overflow-tooltip></el-table-column>

                                        <!-- 5. ISSUE_DETAILS -->
                                        <el-table-column prop="description" label="ISSUE_DETAILS" min-width="250" show-overflow-tooltip></el-table-column>
                                        
                                        <!-- 6. ISSUE_NO -->
                                        <el-table-column prop="id" label="ISSUE_NO" width="100"></el-table-column>
                                        
                                        <!-- 7. ISSUE_TYPE -->
                                        <el-table-column prop="issueType" label="ISSUE_TYPE" width="120"></el-table-column>
                                    </el-table>
                                </div>
                            </div>
                        </div>

                    </transition>
                </div>
            </div>
        </div>

        <!-- Dialogs -->
        <el-dialog v-model="distributeDialogVisible" title="分发任务" width="400px" destroy-on-close>
            <p>正在分发批次：<strong>{{ currentDistributeBatch?.fileName }}</strong></p>
            <el-form label-position="top">
                <el-form-item label="选择校验人员">
                    <el-select v-model="selectedUser" placeholder="请选择用户" style="width: 100%">
                        <el-option label="张三 (User001)" value="User001"></el-option>
                        <el-option label="李四 (User002)" value="User002"></el-option>
                        <el-option label="王五 (User003)" value="User003"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="distributeDialogVisible = false">取消</el-button>
                <el-button type="primary" @click="confirmDistribute">确认分发</el-button>
            </template>
        </el-dialog>

        <el-dialog v-model="correctionDialogVisible" title="人工纠错反馈" width="500px">
            <el-form :model="correctionForm" label-position="top">
                <el-form-item label="AI 预测结果">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #f5f7fa; border-radius: 4px;">
                        <el-tag type="info" effect="dark">{{ currentIssue?.aiCategoryLarge }}</el-tag>
                        <el-icon><Arrow-Right /></el-icon>
                        <el-tag type="info" effect="plain">{{ currentIssue?.aiCategorySub }}</el-tag>
                    </div>
                </el-form-item>
                <el-form-item label="真实类别 (您的判断)">
                    <div style="display: flex; gap: 10px;">
                        <el-input v-model="correctionForm.categoryLarge" placeholder="请输入大类" style="flex: 1"></el-input>
                        <el-input v-model="correctionForm.categorySub" placeholder="请输入子类" style="flex: 1"></el-input>
                    </div>
                </el-form-item>
                <el-form-item label="纠错原因/备注">
                    <el-input type="textarea" v-model="correctionForm.reason" rows="3" placeholder="请简述判断依据，帮助AI更好地学习..."></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <div style="display: flex; justify-content: space-between;">
                    <el-button type="success" plain @click="revertToVerified">确认AI准确</el-button>
                    <div>
                        <el-button @click="correctionDialogVisible = false">取消</el-button>
                        <el-button type="primary" @click="submitCorrection">提交修正</el-button>
                    </div>
                </div>
            </template>
        </el-dialog>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { createApp, ref, reactive, onMounted, nextTick, computed } = Vue;
            const { ElMessage } = ElementPlus;
            
            // 安全处理图标加载
            const ElementPlusIconsVue = window.ElementPlusIconsVue || {};

            const app = createApp({
                setup() {
                    // 安全解构图标
                    const Select = ElementPlusIconsVue.Select || 'span';
                    const EditPen = ElementPlusIconsVue.EditPen || 'span';
                    const Upload = ElementPlusIconsVue.Upload || 'span';
                    const SwitchButton = ElementPlusIconsVue.SwitchButton || 'span';

                    const isLoggedIn = ref(false);
                    const currentRole = ref('admin'); 
                    const loginForm = reactive({ username: '', password: '' });
                    const loginLoading = ref(false);

                    const activeMenu = ref('dashboard');
                    const trendPeriod = ref('7d');
                    const filterStatus = ref('all'); // all, pending, done
                    const filterCategory = ref('');
                    
                    // --- Data ---
                    const stats = reactive({
                        totalPredictions: 12580,
                        pendingBatches: 2,
                        accuracy: 86.5,
                        correctionProgress: 68
                    });

                    const categories = ['网络问题', '硬件问题', '软件问题', '安全问题', '其他'];
                    
                    const batches = ref([
                        { batchId: 'B-231001-001', uploadTime: '2023-10-01 10:00', fileName: 'issue_logs_q3_01.json', totalCount: 100, status: 'completed', assignee: 'User001' },
                        { batchId: 'B-231002-002', uploadTime: '2023-10-02 14:30', fileName: 'issue_logs_q3_02.json', totalCount: 150, status: 'assigned', assignee: 'User001' },
                        { batchId: 'B-231003-003', uploadTime: '2023-10-03 09:15', fileName: 'urgent_issues_v2.json', totalCount: 50, status: 'pending', assignee: null },
                    ]);

                    const myTasks = ref([
                        {
                            batchId: 'B-231002-002',
                            fileName: 'issue_logs_q3_02.json',
                            uploadTime: '2023-10-02',
                            totalCount: 12,
                            processedCount: 2,
                            items: [
                                // Group A: Network
                                { id: 1001, title: 'Case #1001: Connection Lost', description: 'Log shows TCP handshake timeout.', aiCategoryLarge: '网络问题', aiCategorySub: '连接超时', spdt: '分组A', ipmt: 'XX', status: 'verified', resolution: 'Restarted Switch', issueType: 'Connectivity' },
                                { id: 1006, title: 'Case #1006: Timeout', description: 'Connection timed out after 3000ms', aiCategoryLarge: '网络问题', aiCategorySub: '连接超时', spdt: '分组A', ipmt: 'XX', status: 'pending', resolution: 'Increased Timeout', issueType: 'Latency' },
                                { id: 1007, title: 'Case #1007: Reset', description: 'Connection reset by peer', aiCategoryLarge: '网络问题', aiCategorySub: '配置错误', spdt: '分组A', ipmt: 'XX', status: 'pending', resolution: 'Check Firewall', issueType: 'Connectivity' },
                                
                                // Group B: Hardware
                                { id: 1002, title: 'Case #1002: Null Pointer', description: 'Java NullPointerException at Service.java:45', aiCategoryLarge: '硬件问题', aiCategorySub: '内存溢出', spdt: '分组B', ipmt: 'YY', status: 'corrected', humanCategoryLarge: '软件问题', humanCategorySub: '代码异常', reason: '代码问题', resolution: 'Patch Applied', issueType: 'NullRef' },
                                { id: 1003, title: 'Case #1003: Disk Full', description: 'No space left on device /dev/sda1', aiCategoryLarge: '硬件问题', aiCategorySub: '磁盘故障', spdt: '分组B', ipmt: 'YY', status: 'pending', resolution: 'Cleaned Logs', issueType: 'Storage' },
                                { id: 1008, title: 'Case #1008: Memory Error', description: 'OOM Killer triggered', aiCategoryLarge: '硬件问题', aiCategorySub: '内存溢出', spdt: '分组B', ipmt: 'YY', status: 'pending', resolution: 'Added RAM', issueType: 'Memory' },

                                // Group C: Auth
                                { id: 1004, title: 'Case #1004: Auth Failed', description: 'User admin login failed: invalid password', aiCategoryLarge: '安全问题', aiCategorySub: '认证失败', spdt: '分组C', ipmt: 'ZZ', status: 'pending', resolution: 'Reset Password', issueType: 'Auth' },
                                { id: 1009, title: 'Case #1009: 403 Forbidden', description: 'Access denied for resource /api/v1/secret', aiCategoryLarge: '安全问题', aiCategorySub: '权限拒绝', spdt: '分组C', ipmt: 'ZZ', status: 'pending', resolution: 'Grant Role', issueType: 'Auth' },
                                
                                // Group D: Unknown
                                { id: 1005, title: 'Case #1005: Unknown Signal', description: 'Received signal SIGTERM', aiCategoryLarge: '其他', aiCategorySub: '未知原因', spdt: '分组D', ipmt: 'WW', status: 'pending', resolution: 'Investigating', issueType: 'Signal' },
                                { id: 1010, title: 'Case #1010: Crash', description: 'Process died unexpectedly', aiCategoryLarge: '其他', aiCategorySub: '未知原因', spdt: '分组D', ipmt: 'WW', status: 'pending', resolution: 'Check Core Dump', issueType: 'Crash' }
                            ]
                        },
                        {
                            batchId: 'B-231001-001',
                            fileName: 'issue_logs_q3_01.json',
                            uploadTime: '2023-10-01',
                            totalCount: 100,
                            processedCount: 100,
                            items: [] // simulated completed task
                        }
                    ]);

                    const currentTask = ref(null);
                    const distributeDialogVisible = ref(false);
                    const currentDistributeBatch = ref(null);
                    const selectedUser = ref('');
                    const correctionDialogVisible = ref(false);
                    const currentIssue = ref(null);
                    const correctionForm = reactive({ categoryLarge: '', categorySub: '', reason: '' });

                    // --- Charts ---
                    const initCharts = () => {
                        nextTick(() => {
                            // Admin Charts
                            if (currentRole.value === 'admin' && activeMenu.value === 'dashboard') {
                                initAdminCharts();
                            }
                            // User Charts
                            if (currentRole.value === 'user' && activeMenu.value === 'dashboard') {
                                initUserCharts();
                            }
                        });
                    };

                    const initAdminCharts = () => {
                        // Accuracy trend chart removed

                        const elBar = document.getElementById('chart-top-error');
                        if (elBar) {
                            const chart = echarts.init(elBar);
                            chart.setOption({
                                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                                xAxis: { type: 'value' },
                                yAxis: { type: 'category', data: ['网络配置', '软件Bug', '硬件故障', '数据异常', '权限'].reverse() },
                                series: [{ type: 'bar', data: [320, 250, 180, 120, 80].reverse(), itemStyle: { color: '#F56C6C', borderRadius: [0,4,4,0] }, barWidth: '60%' }]
                            });
                        }

                        const elCloud = document.getElementById('chart-wordcloud');
                        if (elCloud) {
                            const chart = echarts.init(elCloud);
                            chart.setOption({
                                 tooltip: { trigger: 'item' },
                                 legend: { bottom: 0, left: 'center' },
                                 series: [{
                                     type: 'pie', radius: ['40%', '70%'], avoidLabelOverlap: false,
                                     itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                                     label: { show: false },
                                     data: [
                                         { value: 1048, name: '网络' }, { value: 735, name: '数据库' },
                                         { value: 580, name: '权限' }, { value: 484, name: 'IO错误' },
                                         { value: 300, name: '其他' }
                                     ]
                                 }]
                            });
                        }
                    };

                    const initUserCharts = () => {
                        // User charts removed
                    };

                    // --- Logic ---
                    const handleLogin = () => {
                        if (!loginForm.username) return ElMessage.warning('请输入用户名');
                        
                        loginLoading.value = true;
                        
                        // 模拟后端验证延迟
                        setTimeout(() => {
                            loginLoading.value = false;
                            const user = loginForm.username.toLowerCase().trim();
                            
                            // 模拟后端权限判定逻辑
                            if (user === 'admin') {
                                currentRole.value = 'admin';
                            } else if (user.startsWith('user')) {
                                currentRole.value = 'user';
                            } else {
                                currentRole.value = 'guest';
                            }

                            isLoggedIn.value = true;
                            
                            if (currentRole.value !== 'guest') {
                                handleRoleChange(); // Reset views
                                ElMessage.success(`登录成功，欢迎回来 ${user}`);
                            } else {
                                ElMessage.warning('当前账号权限待审核');
                            }
                        }, 600);
                    };

                    const logout = () => {
                        isLoggedIn.value = false;
                        loginForm.username = '';
                        loginForm.password = '';
                        ElMessage.info('已退出登录');
                    };

                    const handleRoleChange = () => {
                        activeMenu.value = 'dashboard';
                        currentTask.value = null; // Reset nested views
                        setTimeout(initCharts, 100);
                    };

                    const handleMenuSelect = (key) => {
                        activeMenu.value = key;
                        if (key === 'dashboard') setTimeout(initCharts, 100);
                    };

                    const handleFileChange = (file) => {
                        ElMessage.success(`文件 ${file.name} 已添加到列表`);
                        batches.value.unshift({
                            batchId: `B-23100${batches.value.length+4}`, uploadTime: new Date().toLocaleString(),
                            fileName: file.name, totalCount: Math.floor(Math.random()*100)+50, status: 'pending', assignee: null
                        });
                    };

                    const openDistributeDialog = (row) => {
                        currentDistributeBatch.value = row;
                        // 如果已有分发人，则回显
                        selectedUser.value = row.assignee || '';
                        distributeDialogVisible.value = true;
                    };

                    const confirmDistribute = () => {
                        if(!selectedUser.value) return ElMessage.warning('请选择');
                        
                        // 更新状态和处理人
                        currentDistributeBatch.value.status = 'assigned';
                        currentDistributeBatch.value.assignee = selectedUser.value;
                        
                        distributeDialogVisible.value = false;
                        ElMessage.success(currentDistributeBatch.value.status === 'assigned' ? '分发信息已更新' : '已分发');
                    };

                    const enterTask = (task) => {
                        currentTask.value = task;
                        filterStatus.value = 'all';
                        filterCategory.value = '';
                    };

                    // Updated: Flat list filtering
                    const filteredItems = computed(() => {
                        if (!currentTask.value) return [];
                        return currentTask.value.items.filter(item => {
                            if (filterCategory.value && item.aiCategoryLarge !== filterCategory.value) return false;
                            if (filterStatus.value === 'pending' && item.status !== 'pending') return false;
                            if (filterStatus.value === 'done' && item.status === 'pending') return false;
                            return true;
                        });
                    });

                    const getSummary = (large, sub) => {
                        if (large === '网络问题') return '网络连接超时，日志显示多次握手失败...';
                        if (large === '硬件问题') return '检测到物理设备响应异常，可能是磁盘损坏或内存溢出...';
                        if (large === '软件问题') return '空指针异常或未捕获的运行时错误，需开发介入...';
                        if (large === '安全问题') return '用户尝试访问受限资源，认证失败...';
                        return '异常信号终止，无详细堆栈信息...';
                    };

                    // Updated: Flattened data with span info
                    const tableData = computed(() => {
                        const groups = {};
                        // Group items
                        filteredItems.value.forEach(item => {
                            const key = `${item.spdt}|${item.ipmt}|${item.aiCategoryLarge}|${item.aiCategorySub}`;
                            if (!groups[key]) groups[key] = [];
                            groups[key].push(item);
                        });

                        const result = [];
                        Object.keys(groups).forEach(key => {
                            const items = groups[key];
                            items.forEach((item, index) => {
                                // Create a new object for display to avoid modifying original item
                                const row = { 
                                    ...item,
                                    summary: getSummary(item.aiCategoryLarge, item.aiCategorySub),
                                    groupSize: items.length
                                };
                                // Mark the first item of the group
                                if (index === 0) {
                                    row.rowSpan = items.length;
                                } else {
                                    row.rowSpan = 0;
                                }
                                result.push(row);
                            });
                        });
                        return result;
                    });

                    const objectSpanMethod = ({ row, column, rowIndex, columnIndex }) => {
                        // Merge first 5 columns: SPDT, IPMT, Category, Summary, Count
                        if (columnIndex < 5) {
                            if (row.rowSpan > 0) {
                                return { rowspan: row.rowSpan, colspan: 1 };
                            } else {
                                return { rowspan: 0, colspan: 0 };
                            }
                        }
                    };

                    const verifyIssue = (item) => {
                        if (item.status === 'pending') {
                            currentTask.value.processedCount++;
                        }
                        item.status = 'verified';
                        // Reset correction data
                        item.humanCategoryLarge = null;
                        item.humanCategorySub = null;
                        item.reason = null;
                        ElMessage.success('已标记为准确');
                    };

                    // const batchVerify = (group) => { ... } // Removed batch verify as groups are gone

                    const openCorrection = (item) => {
                        currentIssue.value = item;
                        if (item.status === 'corrected') {
                            // 如果已纠错，回填人工修正的值
                            correctionForm.categoryLarge = item.humanCategoryLarge;
                            correctionForm.categorySub = item.humanCategorySub;
                            correctionForm.reason = item.reason;
                        } else {
                            // 如果是待办(pending)或已确认(verified)，回填AI预测值作为默认
                            correctionForm.categoryLarge = item.aiCategoryLarge;
                            correctionForm.categorySub = item.aiCategorySub;
                            correctionForm.reason = '';
                        }
                        correctionDialogVisible.value = true;
                    };

                    const submitCorrection = () => {
                        if(!correctionForm.categoryLarge || !correctionForm.categorySub) return ElMessage.warning('请完整填写分类信息');
                        
                        if (currentIssue.value.status === 'pending') {
                            currentTask.value.processedCount++;
                        }

                        currentIssue.value.status = 'corrected';
                        currentIssue.value.humanCategoryLarge = correctionForm.categoryLarge;
                        currentIssue.value.humanCategorySub = correctionForm.categorySub;
                        currentIssue.value.humanCategory = `${correctionForm.categoryLarge} > ${correctionForm.categorySub}`; // Fallback or display helper
                        currentIssue.value.reason = correctionForm.reason;
                        
                        correctionDialogVisible.value = false;
                        ElMessage.success('已提交纠错');
                    };

                    const revertToVerified = () => {
                         const item = currentIssue.value;
                         if (item.status === 'pending') {
                             currentTask.value.processedCount++;
                         }
                         item.status = 'verified';
                         item.humanCategoryLarge = null;
                         item.humanCategorySub = null;
                         item.reason = null;
                         correctionDialogVisible.value = false;
                         ElMessage.success('已更正为准确');
                    };

                    const getStatusType = (s) => ({ pending: 'warning', assigned: 'primary', completed: 'success' }[s]);
                    const getStatusText = (s) => ({ pending: '待分发', assigned: '校验中', completed: '已完成' }[s]);
                    const formatNumber = (num) => num.toLocaleString();

                    onMounted(() => {
                        initCharts();
                        window.addEventListener('resize', () => {
                             // echarts.getInstanceByDom(document.getElementById('chart-accuracy-trend'))?.resize(); // Removed
                             echarts.getInstanceByDom(document.getElementById('chart-top-error'))?.resize();
                             echarts.getInstanceByDom(document.getElementById('chart-wordcloud'))?.resize();
                        });
                    });

                    return {
                        currentRole, activeMenu, trendPeriod, filterStatus,
                        stats, batches, myTasks, currentTask, filteredItems, tableData, objectSpanMethod, categories,
                        filterCategory,
                        distributeDialogVisible, currentDistributeBatch, selectedUser,
                        correctionDialogVisible, currentIssue, correctionForm,
                        handleRoleChange, handleMenuSelect, handleFileChange,
                        openDistributeDialog, confirmDistribute, enterTask,
                        verifyIssue, openCorrection, submitCorrection, revertToVerified,
                        getStatusType, getStatusText, formatNumber,
                        // Icons (作为变量使用的)
                        Select, EditPen, Upload, SwitchButton,
                        // Login
                        isLoggedIn, loginForm, loginLoading, handleLogin, logout
                    };
                }
            });

            // 只有当图标库加载成功时才注册所有图标
            if (window.ElementPlusIconsVue) {
                for (const [key, component] of Object.entries(window.ElementPlusIconsVue)) {
                    app.component(key, component);
                }
            }
            
            app.use(ElementPlus);
            app.mount('#app');
        });
    </script>
</body>
</html>
